#!/bin/bash

echo "ğŸ§  Running NeoLight AutoFix Pilot..."
echo "-----------------------------------"

# âœ… 1. Fix permissions
echo "ğŸ”’ Fixing permission issues for .sh scripts..."
chmod +x *.sh tools/*.sh

# âœ… 2. Ensure required Python packages
echo "ğŸ“¦ Ensuring required Python packages..."
pip install -q fastapi uvicorn requests

# âœ… 3. Re-validate API routes
echo "ğŸ” Re-validating backend/main.py routes..."
if ! grep -q "backtest" backend/main.py; then
    echo "â— Missing backtest API route. Run phase_1001_1100_autopilot.sh"
fi

if ! grep -q "portfolio" backend/main.py; then
    echo "â— Portfolio API missing. Run phase_1101_1200_autopilot.sh"
fi

if ! grep -q "console" backend/main.py; then
    echo "â— Console API/UI missing. Run phase_1201_1300_autopilot.sh"
fi

if ! grep -q "mesh" backend/main.py; then
    echo "â— Neural Mesh API missing. Run phase_1301_1400_autopilot.sh"
fi

if ! grep -q "network" backend/main.py; then
    echo "â— Collaborative Network routes missing. Run phase_1401_1500_autopilot.sh"
fi

# âœ… 4. Check mesh adapter
if [ ! -f "mesh/agent_adapter.py" ]; then
    echo "â— Agent mesh adapter missing. Run phase_1501_1520_agent_mesh_autopilot.sh"
fi

# âœ… 5. Check core agent files
for a in sports collectibles luxury studio; do
  if [ ! -f "agents/$a/runner.py" ]; then
    echo "â— Agent $a not found â€” run phase_1521_1560_new_agents_autopilot.sh"
  fi
done

# âœ… 6. Check orchestrator
if [ ! -f "tools/orchestrator.py" ]; then
    echo "â— Orchestrator missing. Run phase_1561_1600_ai_ops_autopilot.sh"
fi

# âœ… 7. Check symbols.json
echo "ğŸ” Checking symbols.json..."
if [ ! -f config/symbols.json ]; then
    echo "â— config/symbols.json is missing!"
else
    cat config/symbols.json
fi

# âœ… 8. Check agents.json
echo "ğŸ•¸ Checking agents.json..."
if [ ! -f config/agents.json ]; then
    echo "â— agents.json missing!"
else
    cat config/agents.json
fi

# âœ… 9. Check optimizer.json
echo "ğŸ“Š Re-validating optimizer.json..."
if [ ! -f config/optimizer.json ]; then
    echo "â— optimizer.json not found"
else
    cat config/optimizer.json
fi

# âœ… 10. Check strategy_daemon.py multi-symbol support
echo "ğŸ” Re-validating strategy_daemon.py..."
if grep -q 'for symbol in symbols' tools/strategy_daemon.py; then
    echo "âœ… strategy_daemon.py is patched."
else
    echo "â— strategy_daemon.py missing multi-asset logic."
fi

# âœ… 11. Strategy Daemon Process
echo "âœ… Strategy daemon check:"
ps aux | grep strategy_daemon | grep -v grep

# âœ… 12. Health endpoint
echo "âœ… FastAPI running check:"
curl -s http://127.0.0.1:8000/api/health || echo "â— Health endpoint may be down"

# âœ… 13. Backend log check
echo "âœ… Log tail:"
tail -n 10 logs/backend.log || echo "â— No logs found."

# âœ… 14. Watchdog check
echo "ğŸ§  Watching logs/watchdog.log (tail -n 10)"
tail -n 10 logs/watchdog.log || echo "â— Watchdog log not found"

echo "ğŸ§© Checking strategy generator components..."
if [ ! -f ai/strategy_generator.py ]; then
    echo "â— strategy_generator.py missing â†’ run phase_1751_1800_strategy_autopilot.sh"
else
    echo "âœ… strategy_generator.py found."
fi

if [ ! -f config/strategies.json ]; then
    echo "â— strategies.json not found â†’ regenerating..."
    python3 ai/strategy_generator.py
else
    echo "âœ… strategies.json present."
fi

echo "ğŸ•¸ Checking Mesh and Telemetry layers..."
[ -f api/mesh/routes.py ] && echo "âœ… Mesh routes OK" || echo "â— Mesh routes missing"
[ -f tools/telemetry_daemon.py ] && echo "âœ… Telemetry daemon OK" || echo "â— Telemetry missing"
[ -f ai/firewall.py ] && echo "âœ… AI Firewall OK" || echo "â— AI Firewall missing"

echo "ğŸ“ˆ Recent Telemetry entries:"
tail -n 5 logs/performance/telemetry.csv 2>/dev/null || echo "â— Telemetry log empty"

echo "ğŸ§  Validating Brain Merge Phase files..."
[ -f ai/brain_merge.py ] && echo "âœ… brain_merge.py present" || echo "â— brain_merge.py missing"
[ -f api/brain/routes.py ] && echo "âœ… brain API routes present" || echo "â— brain API routes missing"
[ -f config/brain.json ] && echo "âœ… brain.json found" || echo "â— brain.json missing â€“ regenerate with ai/brain_merge.py"

echo "ğŸ’¬ Checking NLP and Marketplace components..."
[ -f ai/nlp_query.py ] && echo "âœ… nlp_query.py found" || echo "â— nlp_query.py missing"
[ -f api/nlp/routes.py ] && echo "âœ… NLP routes OK" || echo "â— NLP routes missing"
[ -f api/marketplace/routes.py ] && echo "âœ… Marketplace routes OK" || echo "â— Marketplace routes missing"
[ -f config/marketplace.json ] && echo "âœ… marketplace.json exists" || echo "â— marketplace.json will be created on first publish"

echo "ğŸ‘¥ Checking Collaboration & Deal modules..."
[ -f ai/collaboration_engine.py ] && echo "âœ… collaboration_engine.py OK" || echo "â— collaboration_engine.py missing"
[ -f ai/deal_engine.py ] && echo "âœ… deal_engine.py OK" || echo "â— deal_engine.py missing"
[ -f api/collab/routes.py ] && echo "âœ… Collab routes OK" || echo "â— Collab routes missing"
[ -f api/deal/routes.py ] && echo "âœ… Deal routes OK" || echo "â— Deal routes missing"
tail -n 5 logs/collaboration_log.json 2>/dev/null || echo "â„¹ï¸ No collaboration logs yet"
tail -n 5 logs/deal_log.json 2>/dev/null || echo "â„¹ï¸ No deal logs yet"

echo "ğŸ§  Checking Core Console + Monitors..."
[ -f api/core/routes.py ] && echo "âœ… Core Console OK" || echo "â— core/routes.py missing"
[ -f tools/orchestrator.py ] && echo "âœ… Orchestrator OK" || echo "â— orchestrator.py missing"
[ -f tools/self_heal.py ] && echo "âœ… Self-Heal module OK" || echo "â— self_heal.py missing"
tail -n 5 logs/orchestrator.log 2>/dev/null || echo "â„¹ï¸ No orchestrator logs yet"
tail -n 5 logs/selfheal.log 2>/dev/null || echo "â„¹ï¸ No self-heal logs yet"

echo "ğŸ’¹ Checking portfolio systems..."
[ -f tools/portfolio_updater.py ] && echo "âœ… portfolio_updater.py OK" || echo "â— Missing"
[ -f tools/portfolio_daemon.sh ] && echo "âœ… portfolio_daemon.sh OK" || echo "â— Missing"
[ -f logs/dashboard_portfolio.json ] && tail -n 5 logs/dashboard_portfolio.json || echo "â„¹ï¸ Portfolio log pending refresh"

echo "ğŸŒ Checking multi-asset feed patch..."
grep -q "symbols=json.load" ai/signal_engine.py && echo "âœ… Dynamic symbols active" || echo "â— Static feed detected"
grep -q "execute_trades" ai/trade_executor.py && echo "âœ… Trade executor synced" || echo "â— Executor missing patch"

echo "ğŸ§ª Verifying requests & dotenv in venv..."
if [ -x "./venv/bin/pip" ]; then
  ./venv/bin/pip show requests >/dev/null 2>&1 || ./venv/bin/pip install -q requests
  ./venv/bin/pip show python-dotenv >/dev/null 2>&1 || ./venv/bin/pip install -q python-dotenv
fi

echo "ğŸ” Checking portfolio snapshot..."
[ -f logs/dashboard_portfolio.json ] && tail -n 5 logs/dashboard_portfolio.json || echo "â„¹ï¸ No portfolio snapshot yet (run tools/portfolio_updater.py after setting .env)."

echo "ğŸ”‘ Validating .env keys..."
grep -q "ALPACA_API_KEY=" .env && echo "âœ… Alpaca API key present" || echo "â— Missing Alpaca API key"
grep -q "ALPACA_SECRET_KEY=" .env && echo "âœ… Alpaca secret present" || echo "â— Missing Alpaca secret"
grep -q "ALPACA_API_KEY_ID=" .env && echo "âš ï¸ Duplicate key found â€“ please remove ALPACA_API_KEY_ID"
grep -q "ALPACA_API_SECRET=" .env && echo "âš ï¸ Duplicate key found â€“ please remove ALPACA_API_SECRET"

echo "ğŸŒ Verifying multi-asset feed..."
grep -q "for sym in symbols" ai/signal_engine.py && echo "âœ… Feed rotation active" || echo "â— Feed still static"

echo "ğŸŒ Verifying crypto fallback stack..."
[ -f ai/providers/crypto_provider.py ] && echo "âœ… crypto_provider present" || echo "â— crypto_provider missing"
[ -f ai/providers/data_feed.py ] && echo "âœ… data_feed router OK" || echo "â— data_feed missing"
python3 - <<'PY'
import json, os
ok = os.path.exists("logs/signals.jsonl")
print("ğŸ“ˆ signals.jsonl exists" if ok else "â„¹ï¸ No signals logged yet")
print("ğŸ” symbols:", json.load(open("config/symbols.json")))
PY

echo "ğŸ“¦ Ensuring required Python packages..."
pip install -q fastapi uvicorn requests

echo "ğŸ§© Verifying commodity fallback source..."
if ! grep -q "tradingeconomics" ai/providers/fallback_provider.py; then
    echo "âš™ï¸  Updating fallback provider to TradingEconomics feed..."
    sed -i '' 's/metals-api.com/api.tradingeconomics.com/g' ai/providers/fallback_provider.py
fi

echo "âœ… AutoFix Complete!"


echo "ğŸ§© Verifying commodity feed health..."
python3 - <<'PYCODE'
from ai.providers.commodity_provider import CommodityProvider
from tools.alert_notify import send_alert
provider = CommodityProvider()
data = provider.get_latest_prices()
if not data:
    print("âš ï¸ No commodity data. Sending alert...")
    send_alert("âš ï¸ Commodity feed failure â€” All sources offline.")
else:
    print(f"âœ… Commodity feed OK from {data['source']}: XAU={data.get('XAU')} XAG={data.get('XAG')}")
PYCODE

echo "ğŸ” Commodity cache status:"
[ -f logs/commodity_cache.json ] && cat logs/commodity_cache.json || echo "â— No commodity cache found."

echo "ğŸ§ª Commodity feed quick-check:"
python3 - <<'PY'
from ai.providers.commodity_provider import CommodityProvider
cp=CommodityProvider()
print(cp.get_latest_prices())
PY

echo "ğŸ“ˆ Compute risk policy (quick):"
python3 ai/risk/risk_governor.py
python3 tools/apply_risk_policy.py

echo "ğŸ“‚ Show current weights.json:"
cat config/weights.json || echo "â— weights.json missing"
