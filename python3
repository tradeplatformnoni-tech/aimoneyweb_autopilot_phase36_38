#!/usr/bin/env python3

"""
âœ… AI Money Web â€” Auto Validation + Starter Loop
Runs in one go:
- Validates API/WS health
- Launches fallback poll for Alpaca account
- Starts paper trading loop (supervisor call)
"""

import asyncio
import json
import time
import subprocess
import requests
import websockets

API_BASE = "http://127.0.0.1:8000"
WS_URL = "ws://127.0.0.1:8000/ws/alpaca_status"
ALPACA_API = f"{API_BASE}/api/alpaca_status"
PING = f"{API_BASE}/control/ping"

async def check_websocket():
    try:
        async with websockets.connect(WS_URL) as ws:
            print("âœ… WebSocket connected: /ws/alpaca_status")
            await ws.send("ping")
            msg = await ws.recv()
            print(f"ğŸ“¥ WS Message: {msg[:80]}...")
            return True
    except Exception as e:
        print(f"âŒ WS error: {e}")
        return False

def fallback_poll():
    print("ğŸ” Starting fallback polling for Alpaca status...")
    try:
        while True:
            resp = requests.get(ALPACA_API, timeout=5)
            if resp.status_code == 200:
                data = resp.json()
                print(f"âœ… Alpaca status: {data}")
            else:
                print("âš ï¸ Alpaca API error", resp.status_code)
            time.sleep(5)
    except KeyboardInterrupt:
        print("ğŸ”š Polling stopped.")

def run_start_paper():
    print("ğŸš€ Starting paper trading supervisor...")
    try:
        subprocess.run(["make", "start-paper"], check=True)
    except subprocess.CalledProcessError as e:
        print("âŒ Error running `make start-paper`:", e)

def validate_api():
    print("ğŸ” Checking API...")
    try:
        r = requests.get(PING)
        if r.status_code == 200:
            print("âœ… FastAPI live:", r.json())
        else:
            print("âŒ FastAPI ping failed")
    except Exception as e:
        print("âŒ Exception on API ping:", e)

def validate_alpaca():
    try:
        r = requests.get(ALPACA_API)
        if r.status_code == 200:
            print("âœ… Alpaca API responds:", r.json())
        else:
            print("âŒ Alpaca API unreachable:", r.status_code)
    except Exception as e:
        print("âŒ Alpaca API check failed:", e)

async def main():
    validate_api()
    validate_alpaca()

    print("ğŸ“¡ Checking WebSocket connection...")
    ws_ok = await check_websocket()

    if not ws_ok:
        print("ğŸ› ï¸ WebSocket inactive, falling back to polling...")
        fallback_poll()

    print("ğŸ“ˆ Launching paper trade...")
    run_start_paper()

if __name__ == "__main__":
    asyncio.run(main())

